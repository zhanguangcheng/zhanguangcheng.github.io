(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{434:function(a,s,t){"use strict";t.r(s);var r=t(2),e=Object(r.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("是基于MySQL的服务器的开源热备份实用程序，在备份期间不会锁定数据库。支持的InnoDB，XtraDB和MyISAM表引擎。")]),a._v(" "),s("h1",{attrs:{id:"简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[a._v("#")]),a._v(" 简介")]),a._v(" "),s("p",[a._v("提示：可以结合rsync将备份文件复制到远程服务器上实现灾备，再使用mysqlbinlog工具同步binlog到远程服务器上以备份增量数据")]),a._v(" "),s("ul",[s("li",[s("RouterLink",{attrs:{to:"/posts/2022/inotifywait＋rsync实现远程文件实时同步.html"}},[a._v("inotifywait＋rsync实现远程文件实时同步")])],1),a._v(" "),s("li",[s("RouterLink",{attrs:{to:"/posts/2022/MySQL数据库binlog远程实时备份.html"}},[a._v("MySQL数据库binlog远程实时备份")])],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"https://www.percona.com/software/mysql-database/percona-xtrabackup",target:"_blank",rel:"noopener noreferrer"}},[a._v("Percona XtraBackup"),s("OutboundLink")],1),a._v("是基于MySQL的服务器的开源热备份实用程序，在备份期间不会锁定数据库。支持的InnoDB，XtraDB和MyISAM表引擎。")]),a._v(" "),s("p",[a._v("版本选择：")]),a._v(" "),s("ul",[s("li",[a._v("xtrabackup2.4支持（推荐）：MySQL 5.1，5.5，5.6和5.7")]),a._v(" "),s("li",[a._v("xtrabackup8.0支持：MySQL8.0.0，MySQL8.0.20及以后的版本不支持")])]),a._v(" "),s("h1",{attrs:{id:"安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[a._v("#")]),a._v(" 安装")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("yum "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v(" https://repo.percona.com/yum/percona-release-latest.noarch.rpm\npercona-release enable-only tools release\nyum "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v(" percona-xtrabackup-24 qpress\n")])])]),s("h1",{attrs:{id:"全量备份与恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全量备份与恢复"}},[a._v("#")]),a._v(" 全量备份与恢复")]),a._v(" "),s("h2",{attrs:{id:"创建备份所使用的用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建备份所使用的用户"}},[a._v("#")]),a._v(" 创建备份所使用的用户")]),a._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("CREATE")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("USER")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'backupuser'")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("@'localhost'")]),a._v(" IDENTIFIED "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("BY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'PASSWORD'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("GRANT")]),a._v(" RELOAD"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("LOCK")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("TABLES")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" PROCESS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("REPLICATION")]),a._v(" CLIENT "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("ON")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("TO")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'backupuser'")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("@'localhost'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\nFLUSH "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("PRIVILEGES")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("h2",{attrs:{id:"全量备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全量备份"}},[a._v("#")]),a._v(" 全量备份")]),a._v(" "),s("p",[s("strong",[a._v("参数说明：")])]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('--backup 参数指定为备份的操作\n--target-dir=xxx 目录必须不存在或者为空，否则会备份失败\n--compress 压缩备份\n--databases=\'mysql sys information_schema performance_schema test\' 指定备份的数据库，MySQL自带的库一定要写上，否则恢复后无法启动\n--databases-exclude="db1 db2" 指定不备份的库\n--tables-exclude="db.table1 db.table2" 指定不备份的表\n')])])]),s("p",[s("strong",[a._v("执行备份：")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /data/backups/\nxtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--backup")]),a._v(" --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/\n")])])]),s("h2",{attrs:{id:"全量恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全量恢复"}},[a._v("#")]),a._v(" 全量恢复")]),a._v(" "),s("p",[s("strong",[a._v("注意事项：")])]),a._v(" "),s("ol",[s("li",[a._v("一般情况下为了不影响线上业务，会使用新的MySQL实例进行恢复，然后导出误删的数据进行恢复。")]),a._v(" "),s("li",[a._v("如果备份时压缩过，则需要先解压缩，然后再执行恢复的步骤，解压缩："),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("xtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--decompress")]),a._v(" --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/\n")])])])])]),a._v(" "),s("p",[s("strong",[a._v("恢复步骤：")]),a._v("\n1、恢复前停止MySQL服务，MySQL的datadir目录必须为空。")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("systemctl stop mysqld\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mv")]),a._v(" /var/lib/mysql /var/lib/mysqlbackup\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[a._v("准备恢复，检查是否可恢复，检查中途不能中断\n--prepare参数指定为检查恢复的操作")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("xtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--prepare")]),a._v(" --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[a._v("执行恢复，准备恢复无误后操作")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("--copy-back参数指定为恢复的操作\nxtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" --copy-back --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups\n")])])]),s("p",[a._v("也可以使用文件复制的方式")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("rsync -avrP /data/backups/ /var/lib/mysql/\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[a._v("恢复完成后修正所属者")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chown")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-R")]),a._v(" mysql:mysql /var/lib/mysql\n")])])]),s("ol",{attrs:{start:"5"}},[s("li",[a._v("启动MySQL")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("systemctl start mysqld\n")])])]),s("h1",{attrs:{id:"增量备份与恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#增量备份与恢复"}},[a._v("#")]),a._v(" 增量备份与恢复")]),a._v(" "),s("p",[s("strong",[a._v("注意事项：")])]),a._v(" "),s("ol",[s("li",[a._v("先全量备份，再增量备份，例如每周一次全量备份，基于全量备份每天做一次增量备份，或者每天一次全量备份，每小时一次增量备份。")]),a._v(" "),s("li",[a._v("增量备份可以基于全量备份，也可以基于上次增量备份，根据磁盘容量和数据量大小来选择。")]),a._v(" "),s("li",[a._v("恢复的时候先执行准备恢复，将增量数据合并到全量数据上，最后执行全量数据恢复，需要注意的是最后一次增量恢复准备时不用加参数：--apply-only-log")])]),a._v(" "),s("h2",{attrs:{id:"备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#备份"}},[a._v("#")]),a._v(" 备份")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /data/backups\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#全量备份")]),a._v("\nxtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--backup")]),a._v(" --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/base\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#增量备份一")]),a._v("\nxtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--backup")]),a._v(" --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/inc1 --incremental-basedir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/base\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#增量备份二，基于增量备份一")]),a._v("\nxtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--backup")]),a._v(" --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/inc2 --incremental-basedir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/inc1\n")])])]),s("h2",{attrs:{id:"恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#恢复"}},[a._v("#")]),a._v(" 恢复")]),a._v(" "),s("h3",{attrs:{id:"恢复准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#恢复准备"}},[a._v("#")]),a._v(" 恢复准备")]),a._v(" "),s("p",[a._v("--apply-only-log 来防止回滚阶段")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("systemctl stop mysqld\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mv")]),a._v(" /var/lib/mysql /var/lib/mysqlbackup\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#恢复准备全量备份")]),a._v("\nxtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--prepare")]),a._v(" --apply-log-only --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/base\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#恢复准备增量备份一，这时会将增量备份数据合并到全量备份中")]),a._v("\nxtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--prepare")]),a._v(" --apply-log-only --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/base --incremental-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/inc1\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#恢复准备增量备份二，这时会将增量备份数据合并到全量备份中")]),a._v("\nxtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--prepare")]),a._v(" --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/base --incremental-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/inc2\n")])])]),s("h3",{attrs:{id:"执行恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#执行恢复"}},[a._v("#")]),a._v(" 执行恢复")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("xtrabackup "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("backupuser "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"PASSWORD"')]),a._v(" --copy-back --target-dir"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups/base\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chown")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-R")]),a._v(" mysql:mysql /var/lib/mysql\nsystemctl start mysqld\n")])])]),s("h1",{attrs:{id:"mysql-binlog基于时间点恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql-binlog基于时间点恢复"}},[a._v("#")]),a._v(" MySQL binlog基于时间点恢复")]),a._v(" "),s("p",[a._v("xtrabackup备份数据后会记录MySQL的binlog日志的文件名称和position信息到xtrabackup_binlog_info文件中（需开启MySQL的binlog）")]),a._v(" "),s("p",[a._v("开启binlog\nvim /etc/my.cnf")]),a._v(" "),s("div",{staticClass:"language-ini extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token section"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token section-name selector"}},[a._v("mysqld")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("log_bin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("mysql-bin")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("server-id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[a._v("expire_logs_days")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[a._v("30")]),a._v("\n")])])]),s("p",[a._v("根据binlog基于时间点恢复数据\n注意事项：恢复前关闭binlog日志")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("mysql "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-proot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'set sql_log_bin=0'")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MASTER_LOG_POS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("head")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" /data/backups/xtrabackup_binlog_info"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cut")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f2")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MASTER_LOG_FILE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("head")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" /data/backups/xtrabackup_binlog_info"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cut")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f1")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("\nmysqlbinlog --start-position"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$MASTER_LOG_POS")]),a._v(" --stop-datetime"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2022-07-05 14:13:00"')]),a._v(" /var/lib/mysql/"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$MASTER_LOG_FILE")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" data.sql\nmysql "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-proot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v(" data.sql\nmysql "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-uroot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-proot")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'set sql_log_bin=1'")]),a._v("\n")])])]),s("h1",{attrs:{id:"备份脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#备份脚本"}},[a._v("#")]),a._v(" 备份脚本")]),a._v(" "),s("p",[a._v("方案一：每天01:00一次全量备份，7点至23点每一小时增量备份，保留最近30天的备份")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"0 1,7-23 * * * root /usr/local/scripts/xtrabackup.sh --user=backupuser --password=PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" /etc/crontab\n")])])]),s("p",[a._v("方案二：每周一01:00一次全量备份，每天01:00增量备份，保留最近30天的备份")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"0 1 * * * root /usr/local/scripts/xtrabackup.sh --backup-full-dirname='),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" +%Y-%U"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v(" --backup-inc-dirname="),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" +%u-%Y%m%d"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v(' --user=backupuser --password=PASSWORD"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" /etc/crontab\n")])])]),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" /usr/local/scripts\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /usr/local/scripts/xtrabackup.sh\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" a+x /usr/local/scripts/xtrabackup.sh\n")])])]),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("##!/bin/bash")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_DIR")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/data/backups\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_DAYS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("30")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_COMPRESS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_FULL_DIRNAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" +%Y-%m-%d"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_INC_DIRNAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" +%H-%Y%m%d"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_USER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"root"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"root"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_PORT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("3306")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function-name function"}},[a._v("get_help")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'用法:'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'xtrabackup.sh [options]...'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'options:'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'  --backup-dir=/data/backups             备份保存的路径'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'  --backup-days=30                       备份保留几天'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'  --compress=1                           是否压缩备份'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'  --backup-full-dirname=`date +%Y-%m-%d` 全量备份目录名称，可用于控制全量备份周期，如每天：date +%Y-%m-%d，每周：date +%Y-%U'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'  --backup-inc-dirname=`date +%H-%Y%m%d` 增量备份目录名称，可用于控制增量备份周期，如每天：%H-%Y%m%d，每周：date +%u-%Y%m%d'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'  --user=root                            MySQL用户'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'  --password=root                        MySQL密码'")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'  --port=3306                            MySQL端口'")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("ARGS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),a._v("getopt "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-o")]),a._v(" h "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--long")]),a._v(" help,backup-dir:,backup-days:,compress:,backup-full-dirname:,backup-inc-dirname:,user:,password:,port: "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$0")]),a._v('"')]),a._v(" -- "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$@")]),a._v('"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$?")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Terminating..."')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exit")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#echo ARGS=[$ARGS]")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("eval")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("set")]),a._v(" -- "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ARGS}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("while")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("do")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("case")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$1")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("in")]),a._v("\n\t\t-h"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v("--help"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\tget_help\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exit")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t--backup-dir"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_DIR")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t--backup-days"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_DAYS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t--compress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_COMPRESS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t--backup-full-dirname"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_FULL_DIRNAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t--backup-inc-dirname"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_INC_DIRNAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t--user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_USER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t--password"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t--port"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYSQL_PORT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\t--"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("shift")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("break")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        *"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Internal error!"')]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exit")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("esac")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("done")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("XTRABACKUP")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/usr/bin/xtrabackup\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_DIR_TERM")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR")]),a._v("/"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_FULL_DIRNAME")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_FULL_DIR")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR_TERM")]),a._v("/full\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BACKUP_INC_DIR")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR_TERM")]),a._v("/"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_INC_DIRNAME")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("LOGFILE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR")]),a._v("/backup.log\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("XTRALOGFILE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR")]),a._v("/xtrabackup.log\n\n"),s("span",{pre:!0,attrs:{class:"token function-name function"}},[a._v("backup_run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\tbackup_init\n\tbackup_database\n\tbackup_clean\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function-name function"}},[a._v("backup_init")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$XTRABACKUP")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$XTRABACKUP")]),a._v(' 不存在"')]),a._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exit")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR_TERM")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR_TERM")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function-name function"}},[a._v("backup_clean")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("find")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-type")]),a._v(" d "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-mtime")]),a._v(" +"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DAYS")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-exec")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dev/null "),s("span",{pre:!0,attrs:{class:"token operator"}},[s("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("2")]),a._v(">")]),s("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("&1")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function-name function"}},[a._v("save_log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\t"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"['),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),a._v(" +"),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'%Y-%m-%d %H:%M:%S'")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("] "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$1")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$LOGFILE")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function-name function"}},[a._v("backup_database")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("COMMAND")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$XTRABACKUP")]),a._v(" --user="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$MYSQL_USER")]),a._v(" --password="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$MYSQL_PASSWORD")]),a._v(" --port="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$MYSQL_PORT")]),a._v(' --backup"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("NEWEST_DIRNAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" $BACKUP_DIR_TERM "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("head")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$NEWEST_DIRNAME")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('""')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("COMMAND")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$COMMAND")]),a._v(" --target-dir="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_FULL_DIR")]),a._v('"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BASEDIR")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_DIR_TERM")]),a._v("/"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$NEWEST_DIRNAME")]),a._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("COMMAND")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$COMMAND")]),a._v(" --target-dir="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_INC_DIR")]),a._v(" --incremental-basedir="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BASEDIR")]),a._v('"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$BACKUP_COMPRESS")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-eq")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("COMMAND")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$COMMAND")]),a._v(' --compress"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n\n    save_log "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"beging backup:'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$COMMAND")]),a._v('"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("$COMMAND "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" $XTRALOGFILE "),s("span",{pre:!0,attrs:{class:"token operator"}},[s("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("2")]),a._v(">")]),s("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[a._v("&1")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$?")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-eq")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n        save_log "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"backup successful"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("else")]),a._v("\n        save_log "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"backup failure"')]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\nbackup_run\n")])])]),s("blockquote",[s("p",[a._v("🕑 最后更新时间: 2022-10-16 15:05")])])])}),[],!1,null,null,null);s.default=e.exports}}]);